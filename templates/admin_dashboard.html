<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç®¡ç†å¾Œå°</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    {% include 'navbar.html' %}
    <div class="container mt-4">
      <h1 class="text-center">ğŸ‘¤ ç®¡ç†å¾Œå°</h1>

      <ul class="nav nav-tabs" id="adminTabs">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="announcements-tab"
            data-bs-toggle="tab"
            href="#announcements"
            >ğŸ“¢ å…¬å‘Šç®¡ç†</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link" id="users-tab" data-bs-toggle="tab" href="#users"
            >ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="carousel-tab"
            data-bs-toggle="tab"
            href="#carousel"
            >ğŸ–¼ï¸ è¼ªæ’­ç®¡ç†</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="evaluation-tab"
            data-bs-toggle="tab"
            href="#evaluation"
            >ğŸ“œ è©•é‘‘è¾¦æ³•</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link" id="club-tab" data-bs-toggle="tab" href="#club"
            >ğŸ“‹ ç¤¾åœ˜åå–®ç®¡ç†</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="voting-management-tab"
            data-bs-toggle="tab"
            href="#voting-management"
            >ğŸ† äººæ°£çç®¡ç†</a
          >
        </li>
      </ul>

      <div class="tab-content mt-3">
        <!-- å…¬å‘Šç®¡ç† -->
        <div class="tab-pane fade show active" id="announcements">
          <h2>ğŸ“¢ æ–°å¢å…¬å‘Š</h2>
          <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="action" value="add_announcement" />
            <div class="mb-3">
              <label for="title" class="form-label">æ¨™é¡Œï¼š</label>
              <input type="text" name="title" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="content" class="form-label">å…§å®¹ï¼š</label>
              <textarea name="content" class="form-control" required></textarea>
            </div>
            <div class="mb-3">
              <label for="file" class="form-label">é™„ä»¶ (å¯é¸)ï¼š</label>
              <input type="file" name="file" class="form-control" />
            </div>
            <div class="mb-3">
              <input type="checkbox" name="in_carousel" id="in_carousel" />
              <label for="in_carousel">åŠ å…¥è¼ªæ’­</label>
              <input type="file" name="carousel_image" class="form-control" />
            </div>
            <button type="submit" class="btn btn-success">æ–°å¢å…¬å‘Š</button>
          </form>
        </div>

        <!-- ç”¨æˆ¶ç®¡ç† -->
        <div class="tab-pane fade" id="users">
          <h2>ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h2>

          <!-- å¹´ä»½ç¯©é¸ -->
          <div class="row mb-3">
            <div class="col-md-4">
              <select
                id="userYearFilter"
                class="form-control"
                onchange="filterUsers()"
              >
                <option value="">ğŸ“… éæ¿¾å¹´ä»½ï¼ˆå…¨éƒ¨ï¼‰</option>
                {% for year in years %}
                <option value="{{ year }}">{{ year }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <ul class="nav nav-tabs">
            <li class="nav-item">
              <a
                class="nav-link active"
                id="single-user-tab"
                data-bs-toggle="tab"
                href="#single-user"
                >â• å–®ä¸€æ–°å¢ç”¨æˆ¶</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                id="batch-user-tab"
                data-bs-toggle="tab"
                href="#batch-user"
                >ğŸ“© æ‰¹é‡æ–°å¢ç”¨æˆ¶</a
              >
            </li>
          </ul>

          <div class="tab-content mt-3">
            <!-- å–®ä¸€æ–°å¢ç”¨æˆ¶ -->
            <div class="tab-pane fade show active" id="single-user">
              <form method="POST">
                <input type="hidden" name="action" value="add_user" />
                <div class="row">
                  <div class="col-md-3">
                    <label class="form-label">ç¤¾åœ˜åç¨±ï¼š</label>
                    <select name="club_id" class="form-control">
                      {% for club in clubs %}
                      <option value="{{ club.id }}">
                        {{ club.club_name }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">å§“åï¼š</label>
                    <input
                      type="text"
                      name="full_name"
                      class="form-control"
                      required
                    />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Emailï¼š</label>
                    <input
                      type="email"
                      name="email"
                      class="form-control"
                      required
                    />
                  </div>
                </div>
                <button type="submit" class="btn btn-success mt-3">
                  æ–°å¢ç”¨æˆ¶
                </button>
              </form>
            </div>

            <!-- æ‰¹é‡æ–°å¢ç”¨æˆ¶ -->
            <div class="tab-pane fade" id="batch-user">
              <form method="POST">
                <input type="hidden" name="action" value="add_users" />
                <div class="mb-3">
                  <label class="form-label"
                    >Email æ¸…å–®ï¼ˆå¤šå€‹ Email ä»¥ `,` åˆ†éš”ï¼‰ï¼š</label
                  >
                  <textarea
                    name="emails"
                    class="form-control"
                    required
                  ></textarea>
                </div>
                <button type="submit" class="btn btn-primary">æ‰¹é‡æ–°å¢</button>
              </form>
            </div>
          </div>

          <!-- ç”¨æˆ¶åå–® -->
          <h3 class="mt-4">ğŸ“œ ç”¨æˆ¶åˆ—è¡¨</h3>
          <table class="table table-bordered mt-3" id="userTable">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>Email</th>
                <th>ç¤¾åœ˜</th>
                <th>æ–°å¢å¹´ä»½</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr class="user-row" data-year="{{ user.created_at.year }}">
                <td>{{ user.full_name }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.club.club_name if user.club else 'æœªåˆ†é…' }}</td>
                <td>{{ user.created_at.year }}</td>
                <td>
                  <form method="POST" class="d-inline">
                    <input type="hidden" name="action" value="delete_user" />
                    <input type="hidden" name="user_id" value="{{ user.id }}" />
                    <button type="submit" class="btn btn-danger btn-sm">
                      åˆªé™¤
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- è¼ªæ’­ç®¡ç† -->
        <div class="tab-pane fade" id="carousel">
          <h2>ğŸ–¼ï¸ ç®¡ç†è¼ªæ’­åœ–</h2>
          <table class="table">
            <thead>
              <tr>
                <th>åœ–ç‰‡</th>
                <th>é †åº</th>
                <th>å•Ÿç”¨</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {% for image in carousel_images %}
              <tr>
                <td><img src="{{ image.image_path }}" width="100" /></td>
                <td>{{ image.order }}</td>
                <td>{{ "âœ… å•Ÿç”¨" if image.is_active else "âŒ åœç”¨" }}</td>
                <td>
                  <form method="POST">
                    <input
                      type="hidden"
                      name="image_id"
                      value="{{ image.id }}"
                    />
                    <button
                      type="submit"
                      name="toggle_carousel"
                      class="btn btn-warning"
                    >
                      åˆ‡æ›ç‹€æ…‹
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- è©•é‘‘è¾¦æ³• -->
        <div class="tab-pane fade" id="evaluation">
          <h2>ğŸ“œ ç®¡ç†è©•é‘‘è¾¦æ³•</h2>
          <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="action" value="update_evaluation" />
            <div class="mb-3">
              <label for="title" class="form-label">æ¨™é¡Œï¼š</label>
              <input type="text" name="title" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="content" class="form-label">å…§å®¹ï¼š</label>
              <textarea name="content" class="form-control" required></textarea>
            </div>
            <div class="mb-3">
              <label for="file" class="form-label">é™„ä»¶ (å¯é¸)ï¼š</label>
              <input type="file" name="file" class="form-control" />
            </div>
            <button type="submit" class="btn btn-success">æ›´æ–°è©•é‘‘è¾¦æ³•</button>
          </form>
        </div>
        <!-- ç¤¾åœ˜åå–®ç®¡ç† -->
        <div class="tab-pane fade" id="club">
          <h2>ğŸ“‹ ç¤¾åœ˜åå–®ç®¡ç†</h2>

          <!-- æœå°‹èˆ‡ç¯©é¸ -->
          <div class="row mb-3">
            <div class="col-md-5">
              <input
                type="text"
                id="clubSearch"
                class="form-control"
                placeholder="ğŸ” æœå°‹ç¤¾åœ˜åç¨±..."
              />
            </div>
            <div class="col-md-4">
              <select id="clubCategoryFilter" class="form-control">
                <option value="">ğŸ“‚ éæ¿¾åˆ†é¡ï¼ˆå…¨éƒ¨ï¼‰</option>
                <option value="å­¸è¡“æ–‡è—æ€§">å­¸è¡“æ–‡è—æ€§</option>
                <option value="åº·æ¨‚æ€§">åº·æ¨‚æ€§</option>
                <option value="è¯èª¼æ€§">è¯èª¼æ€§</option>
                <option value="æœå‹™æ€§">æœå‹™æ€§</option>
                <option value="ç¾©å·¥æ€§">ç¾©å·¥æ€§</option>
                <option value="é«”è‚²æ€§">é«”è‚²æ€§</option>
                <option value="è‡ªæ²»æ€§">è‡ªæ²»æ€§</option>
              </select>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary" onclick="filterClubs()">
                ğŸ” æœå°‹
              </button>
              <button
                class="btn btn-secondary"
                data-bs-toggle="modal"
                data-bs-target="#addClubModal"
              >
                â• æ–°å¢ç¤¾åœ˜
              </button>
            </div>
          </div>

          <!-- ç¤¾åœ˜åå–®è¡¨æ ¼ -->
          <table class="table table-bordered mt-3" id="clubTable">
            <thead>
              <tr>
                <th>ç¤¾åœ˜åç¨±</th>
                <th>ç¤¾åœ˜åˆ†é¡</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {% for club in clubs %}
              <tr class="club-row">
                <td class="club-name">{{ club.club_name }}</td>
                <td class="club-category">{{ club.club_category }}</td>
                <td>
                  <form method="POST" class="d-inline">
                    <input type="hidden" name="action" value="delete_club" />
                    <input type="hidden" name="club_id" value="{{ club.id }}" />
                    <button type="submit" class="btn btn-danger btn-sm">
                      åˆªé™¤
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <!-- äººæ°£çç®¡ç† -->
        <div class="tab-pane fade" id="voting-management">
          <h2>ğŸ† äººæ°£çç®¡ç†</h2>

          <!-- è¨­å®šæŠ•ç¥¨æ™‚é–“ -->
          <h4>ğŸ“… æŠ•ç¥¨æ™‚é–“è¨­å®š</h4>
          <form method="POST">
            <input type="hidden" name="action" value="update_voting_time" />
            <div class="row">
              <div class="col-md-5">
                <label class="form-label">æŠ•ç¥¨é–‹å§‹æ™‚é–“ï¼š</label>
                <input
                  type="datetime-local"
                  name="start_time"
                  class="form-control"
                  value="{{ voting_config.start_time.strftime('%Y-%m-%dT%H:%M') if voting_config else '' }}"
                  required
                />
              </div>
              <div class="col-md-5">
                <label class="form-label">æŠ•ç¥¨çµæŸæ™‚é–“ï¼š</label>
                <input
                  type="datetime-local"
                  name="end_time"
                  class="form-control"
                  value="{{ voting_config.end_time.strftime('%Y-%m-%dT%H:%M') if voting_config else '' }}"
                  required
                />
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">
                  æ›´æ–°æŠ•ç¥¨æ™‚é–“
                </button>
              </div>
            </div>
          </form>
          <hr />

          <!-- ç›®å‰ç¥¨æ•¸çµ±è¨ˆ -->
          <h4>ğŸ“Š ç›®å‰æŠ•ç¥¨çµæœ</h4>
          <table class="table table-bordered mt-3">
            <thead>
              <tr>
                <th>æ’å</th>
                <th>ç¤¾åœ˜åç¨±</th>
                <th>ç¥¨æ•¸</th>
              </tr>
            </thead>
            <tbody>
              {% for club_name, vote_count in vote_results %}
              <tr>
                <td>#{{ loop.index }}</td>
                <td>{{ club_name }}</td>
                <td>{{ vote_count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <hr />

          <!-- é‡ç½®æŠ•ç¥¨ -->
          <h4>âš ï¸ é‡ç½®æŠ•ç¥¨</h4>
          <p class="text-danger">æ­¤æ“ä½œå°‡æ¸…ç©ºæ‰€æœ‰æŠ•ç¥¨ç´€éŒ„ï¼Œè«‹è¬¹æ…æ“ä½œï¼</p>
          <form method="POST">
            <input type="hidden" name="action" value="reset_votes" />
            <button type="submit" class="btn btn-danger">é‡ç½®æ‰€æœ‰æŠ•ç¥¨</button>
          </form>
        </div>
      </div>

      <!-- ğŸ“Œ æ–°å¢ç¤¾åœ˜æ¨¡æ…‹è¦–çª— -->
      <div
        class="modal fade"
        id="addClubModal"
        tabindex="-1"
        aria-labelledby="addClubLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addClubLabel">æ–°å¢ç¤¾åœ˜</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form method="POST">
                <input type="hidden" name="action" value="add_club_batch" />

                <!-- é¸æ“‡æ–°å¢æ¨¡å¼ -->
                <div class="mb-3">
                  <label class="form-label">é¸æ“‡æ–°å¢æ–¹å¼ï¼š</label>
                  <select
                    id="addMode"
                    class="form-control"
                    onchange="toggleAddMode()"
                  >
                    <option value="single">å–®ä¸€æ–°å¢</option>
                    <option value="batch">æ‰¹é‡æ–°å¢</option>
                  </select>
                </div>

                <!-- å–®ä¸€æ–°å¢ -->
                <div id="singleClubForm">
                  <div class="mb-3">
                    <label class="form-label">ç¤¾åœ˜åç¨±ï¼š</label>
                    <input
                      type="text"
                      name="single_club_name"
                      class="form-control"
                    />
                  </div>
                </div>

                <!-- æ‰¹é‡æ–°å¢ -->
                <div id="batchClubForm" style="display: none">
                  <div class="mb-3">
                    <label class="form-label"
                      >æ‰¹é‡æ–°å¢ï¼ˆæ¯è¡Œä¸€å€‹ç¤¾åœ˜åç¨±ï¼‰ï¼š</label
                    >
                    <textarea
                      name="batch_club_names"
                      class="form-control"
                      rows="4"
                    ></textarea>
                  </div>
                </div>

                <!-- é¸æ“‡åˆ†é¡ -->
                <div class="mb-3">
                  <label class="form-label">ç¤¾åœ˜åˆ†é¡ï¼š</label>
                  <select name="club_category" class="form-control" required>
                    <option value="" disabled selected>è«‹é¸æ“‡åˆ†é¡</option>
                    <option value="å­¸è¡“æ–‡è—æ€§">å­¸è¡“æ–‡è—æ€§</option>
                    <option value="åº·æ¨‚æ€§">åº·æ¨‚æ€§</option>
                    <option value="è¯èª¼æ€§">è¯èª¼æ€§</option>
                    <option value="æœå‹™æ€§">æœå‹™æ€§</option>
                    <option value="ç¾©å·¥æ€§">ç¾©å·¥æ€§</option>
                    <option value="é«”è‚²æ€§">é«”è‚²æ€§</option>
                    <option value="è‡ªæ²»æ€§">è‡ªæ²»æ€§</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-success">æäº¤</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document
        .getElementById("userYearFilter")
        .addEventListener("change", filterUsers);
      document
        .getElementById("clubCategoryFilter")
        .addEventListener("change", filterClubs);
      document
        .getElementById("clubSearch")
        .addEventListener("keyup", filterClubs);
    });

    // âœ… ä¿®æ­£ã€Œç”¨æˆ¶å¹´ä»½ç¯©é¸ã€
    function filterUsers() {
      let selectedYear = document.getElementById("userYearFilter").value;
      let rows = document.querySelectorAll(".user-row");

      rows.forEach((row) => {
        let userYear = row.getAttribute("data-year");
        row.style.display =
          selectedYear === "" || userYear === selectedYear ? "" : "none";
      });
    }

    // åˆ‡æ›ã€Œå–®ä¸€æ–°å¢ã€èˆ‡ã€Œæ‰¹é‡æ–°å¢ã€è¡¨å–®
    function toggleAddMode() {
      let mode = document.getElementById("addMode").value;
      document.getElementById("singleClubForm").style.display =
        mode === "single" ? "block" : "none";
      document.getElementById("batchClubForm").style.display =
        mode === "batch" ? "block" : "none";
    }

    // é»æ“Šæœå°‹å¾Œç¯©é¸ç¤¾åœ˜
    function filterClubs() {
      let searchInput = document
        .getElementById("clubSearch")
        .value.toLowerCase();
      let categoryFilter = document.getElementById("clubCategoryFilter").value;
      let rows = document.querySelectorAll(".club-row");

      rows.forEach((row) => {
        let clubName = row
          .querySelector(".club-name")
          .textContent.toLowerCase();
        let clubCategory = row.querySelector(".club-category").textContent;

        let nameMatch = clubName.includes(searchInput);
        let categoryMatch =
          categoryFilter === "" || clubCategory === categoryFilter;

        row.style.display = nameMatch && categoryMatch ? "" : "none";
      });
    }
  </script>
</html>
